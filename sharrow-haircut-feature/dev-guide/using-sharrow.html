
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Using Sharrow &#8212; ActivitySim 1.2.0.dev409+g0d53eca3</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/autodoc_pydantic.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/theme_overrides.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/design-tabs.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Workflows" href="workflows.html" />
    <link rel="prev" title="Developer Installation" href="install.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    
<a class="navbar-brand" href="../index.html">
<p class="title">ActivitySim</p>
</a>

    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../users-guide/index.html">
  Users Guide
 </a>
</li>

<li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="index.html">
  Developers
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <div class="dropdown" id="version_switcher">
    <button type="button" class="btn btn-primary btn-sm navbar-btn dropdown-toggle" id="version_switcher_button" data-toggle="dropdown">
        1.2.0  <!-- this text may get changed later by javascript -->
        <span class="caret"></span>
    </button>
    <div id="version_switcher_menu" class="dropdown-menu list-group-flush py-0" aria-labelledby="version_switcher_button">
    <!-- dropdown will be populated by javascript on page load -->
    </div>
</div>

<!-- NOTE: this JS must live here (not in our global JS file) because it relies
     on being processed by Jinja before it is run (specifically for replacing
     variables dev-guide/using-sharrow and {'json_url': 'https://camsys.github.io/activitysim/switcher.json', 'version_match': '1.2.0'}.
-->

<script type="text/javascript">
// Check if corresponding page path exists in other version of docs
// and, if so, go there instead of the homepage of the other docs version
function checkPageExistsAndRedirect(event) {
    const currentFilePath = "dev-guide/using-sharrow.html",
          tryUrl = event.target.getAttribute("href");
    let otherDocsHomepage = tryUrl.replace(currentFilePath, "");
    $.ajax({
        type: 'HEAD',
        url: tryUrl,
        // if the page exists, go there
        success: function() {
            location.href = tryUrl;
        }
    }).fail(function() {
        location.href = otherDocsHomepage;
    });
    // this prevents the browser from following the href of the clicked node
    // (which is fine because this function takes care of redirecting)
    return false;
}

// Populate the version switcher from the JSON config file
(function () {
    $.getJSON("https://camsys.github.io/activitysim/switcher.json", function(data, textStatus, jqXHR) {
        const currentFilePath = "dev-guide/using-sharrow.html";
        // create links to the corresponding page in the other docs versions
        $.each(data, function(index, entry) {
            // if no custom name specified (e.g., "latest"), use version string
            if (!("name" in entry)) {
                entry.name = entry.version;
            }
            // create the node
            const node = document.createElement("a");
            node.setAttribute("class", "list-group-item list-group-item-action py-1");
            node.textContent = `${entry.name}`;
            node.setAttribute("href", `${entry.url}${currentFilePath}`);
            // on click, AJAX calls will check if the linked page exists before
            // trying to redirect, and if not, will redirect to the homepage
            // for that version of the docs.
            node.onclick = checkPageExistsAndRedirect;
            // Add dataset values for the version and name in case people want
            // to apply CSS styling based on this information.
            node.dataset["versionName"] = entry.name;
            node.dataset["version"] = entry.version;

            $("#version_switcher_menu").append(node);
            // replace dropdown button text with the preferred display name of
            // this version, rather than using sphinx's 1.2.0 variable.
            // also highlight the dropdown entry for the currently-viewed
            // version's entry
            if (entry.version == "1.2.0") {
                node.classList.add("active");
                let btn = document.getElementById("version_switcher_button");
                btn.innerText = btn.dataset["activeVersionName"] = entry.name;
                btn.dataset["activeVersion"] = entry.version;
            }
        });
    });
})();
</script>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="install.html">
   Developer Installation
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Using Sharrow
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="workflows.html">
   Workflows
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../development.html">
   Software Development
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../models.html">
   Models
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="components/index.html">
   Components
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="components/trip_destination.html">
     Trip Destination
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../core.html">
   Core Components
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../benchmarking.html">
   Benchmarking
  </a>
 </li>
</ul>

  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage mt-5 pt-1 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#how-it-works">
   How it Works
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#getting-the-code">
   Getting the Code
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#prototype-mtc-examples">
   Prototype MTC Examples
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#sharrow-compatability-and-limitations">
   Sharrow Compatability and Limitations
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#temporary-variables">
     Temporary Variables
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#switchable-expressions">
     Switchable Expressions
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#performance-considerations">
     Performance Considerations
    </a>
   </li>
  </ul>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="using-sharrow">
<h1>Using Sharrow<a class="headerlink" href="#using-sharrow" title="Permalink to this headline">#</a></h1>
<p>This page will walk through an exercise of running a model with <code class="docutils literal notranslate"><span class="pre">sharrow</span></code>.</p>
<section id="how-it-works">
<h2>How it Works<a class="headerlink" href="#how-it-works" title="Permalink to this headline">#</a></h2>
<p>Sharrow accelerates ActivitySim in part by using numba to create optimized and
pre-compiled versions of utility specification files, and caching those bits
of code to disk.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Running the compiler needs to be done in single-process mode, otherwise the
various process all do the compiling and compete to write to the same cache
location on disk, which is likely to fail.  You can safely run in
multiprocessing mode after all the compilation for all model components is
complete.</p>
</div>
</section>
<section id="getting-the-code">
<h2>Getting the Code<a class="headerlink" href="#getting-the-code" title="Permalink to this headline">#</a></h2>
<p>We’ll assume that activitysim and sharrow have been installed in editable
mode, per the <a class="reference internal" href="install.html"><span class="doc std std-doc">developer install instructions</span></a>.</p>
<p>The code to implement <code class="docutils literal notranslate"><span class="pre">sharrow</span></code> in <code class="docutils literal notranslate"><span class="pre">activitysim</span></code> is in the
<a class="reference external" href="https://github.com/camsys/activitysim/tree/sharrow-black">sharrow-black</a> branch
of the <a class="reference external" href="https://github.com/camsys/activitysim">camsys/activitysim</a> repository.
If you have checked out from this repository directly, you can just switch to
the correct branch:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> activitysim
git switch sharrow-black
<span class="nb">cd</span> ..
</pre></div>
</div>
<p>If your local Git repository is configured with only the main ActivitySim
parent repo as its remote, you can find the code in
<a class="reference external" href="https://github.com/ActivitySim/activitysim/pull/579">PR #579</a>, accessible on the
command line using the <code class="docutils literal notranslate"><span class="pre">gh</span></code> tool:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> activitysim
gh pr checkout <span class="m">579</span>  <span class="c1"># use `gh auth login` first if needed</span>
<span class="nb">cd</span> ..
</pre></div>
</div>
</section>
<section id="prototype-mtc-examples">
<h2>Prototype MTC Examples<a class="headerlink" href="#prototype-mtc-examples" title="Permalink to this headline">#</a></h2>
<p>Testing with sharrow requires two steps: test mode and production mode.</p>
<p>In test mode, the code is run to compile all the spec files and
ascertain whether the functions are working correctly.  Production mode
can then just run the pre-compiled functions with sharrow, which is much
faster.</p>
<p>You can run both, plus the ActivitySim in “legacy” mode that does not use sharrow,
as well as a reference implementation (version 1.0.4), all together using the
“mini” dataset for testing in one workflow.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>activitysim workflow sharrow-contrast/mtc_mini
</pre></div>
</div>
<p>Alternatively, you can use the full size skims.  To test this model with
100k households and full skims (1475 zones), you can run the “mtc_full” workflow:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>activitysim workflow sharrow-contrast/mtc_full
</pre></div>
</div>
<p>To use the full synthetic population as well, run the multiprocess workflow:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>activitysim workflow sharrow-contrast/mtc_mp
</pre></div>
</div>
<p>Lastly, a comprehensive performance testing suite on the prototype MTC model
(warning: this takes hours!)</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>activitysim workflow sharrow-contrast/mtc_comprehensive
</pre></div>
</div>
<p>All these performance tests assume you have sufficient RAM to run without chunking.</p>
</section>
<section id="sharrow-compatability-and-limitations">
<h2>Sharrow Compatability and Limitations<a class="headerlink" href="#sharrow-compatability-and-limitations" title="Permalink to this headline">#</a></h2>
<p>In general, utility specification files contain a sequence of :ref:<code class="docutils literal notranslate"><span class="pre">expressions</span></code> that
are evaluated for each row in a main DataFrame.  In legacy ActivitySim,
there are two fundamental evaluation modes:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">pandas.DataFrame.eval</span></code>, which is the default, and</p></li>
<li><p>plain Python <code class="docutils literal notranslate"><span class="pre">eval</span></code>, which is used when the expression is prefixed with an “&#64;” symbol.</p></li>
</ul>
<p>Under the <code class="docutils literal notranslate"><span class="pre">pandas.DataFrame.eval</span></code> mode, expressions are evaluated within the context
of the current main dataframe only. References can be made to other columns
in that dataframe directly, i.e. if the dataframe contains a column named “income”,
the expression can reference that value as “income”.  However, the expression can
<em>only</em> reference other values that are stored in the current row of the dataframe.
The available syntax for these expressions is a subset of regular python, see the
<a class="reference external" href="https://pandas.pydata.org/docs/user_guide/enhancingperf.html#supported-syntax">supported syntax</a>
section of the pandas documentation for details.</p>
<p>Under the plain <code class="docutils literal notranslate"><span class="pre">eval</span></code> mode, expressions are evaluated within a broader context
that potentially includes other variables (which other variables is component
dependent) and constants defined in the model settings file.  References to
columns in the main dataframe must be made indirectly via attribution, i.e. if
the dataframe contains a column named “income”, the expression needs to reference
that value as “df.income”.  Typically, references to skims, time tables, and anything
else that isn’t the simple original dataframe use this mode.  While it is sometimes
not as fast as <code class="docutils literal notranslate"><span class="pre">pandas.DataFrame.eval</span></code>, this mode is far more flexible, as you
can write basically any valid Python expression, including calling other functions,
accessing or manipulating table metadata, indexes, or adjacent rows, etc.</p>
<p>Within sharrow, the distinction between these two modes is ignored, as sharrow
uses a completely different evaluation system routed through numba. The “&#64;” prefix
does not need to be stripped or added anywhere, it is simply ignored. The expression
can reference other columns of the main dataframe directly or indirectly, so that
either “income” or “df.income” is a valid reference to that column in the main
dataframe.  You can also reference other variables, including skims, time tables,
and constants defined in in the model settings file.  However, you <em>cannot</em> write
any arbitrary Python code.  External functions are not allowed unless they have
already been compiled with numba’s <code class="docutils literal notranslate"><span class="pre">njit</span></code> wrapper.  Typically, unless specifically
constructed to be allowed for a model component, cross-referencing, merging or
reindexing against tables other than the main dataframe is not allowed.</p>
<p>Sharrow only runs for utility specification files.  ActivitySim also features the
ability to apply pre-processors and post-processors to annotate tables, which use
specification files that look very similar to utility specifications.  These
functions do <em>not</em> run through sharrow, and are a great place to relocation expressions
that need to run arbitrary code or join data from other table.</p>
<section id="temporary-variables">
<h3>Temporary Variables<a class="headerlink" href="#temporary-variables" title="Permalink to this headline">#</a></h3>
<p>Temporary variables can be created from “&#64;” mode expressions by adding a variable
name beginning with an underscore before the “&#64;”, e.g. “_stops_on_leg&#64;df.trip_count-1”.</p>
<p>In legacy mode, temporary variables are useful but they can consume substantial
memory, as the variable is computed and stored for every row in the entire dataframe
before it can be used in other expressions.  In sharrow, temporary variables are
allocated, used, and freed for each row seperately, so no extra memory is required.</p>
</section>
<section id="switchable-expressions">
<h3>Switchable Expressions<a class="headerlink" href="#switchable-expressions" title="Permalink to this headline">#</a></h3>
<p>As a general rule, it is best to write each utility expression in a manner that
is cross-compatible between sharrow and legacy evaluation modes, even if that
means transitioning a few expressions or parts of expressions into preprocessors.</p>
<p>However, sometimes this is not possible or makes writing the expressions excessively
complex.  In this case, it is possible to write a toggling expression, where the
individual expression evaluated is different for sharrow and legacy modes.  The
special comment string “# sharrow:” splits the expression, with everything before this
comment evaluated under the legacy process, and everything after evaluated only
when sharrow is enabled.</p>
</section>
<section id="performance-considerations">
<h3>Performance Considerations<a class="headerlink" href="#performance-considerations" title="Permalink to this headline">#</a></h3>
<p>Sharrow is usually expected to bring significant performance gains to ActivitySim.
However, the numba engine beneath sharrow has a few known performance limitations,
most notably when using <a class="reference external" href="https://numba.readthedocs.io/en/stable/reference/pysupported.html#str">strings</a>.
To enhance performance, it is best to limit the number of string operations,
including simple equality checks (e.g. <code class="docutils literal notranslate"><span class="pre">df.tour_purpose</span> <span class="pre">==</span> <span class="pre">'work'</span></code>).  Ideally,
such string operations won’t appear in utility specifications at all, or if they
do appear, they are executed only once and stored in a temporary value for re-use
as needed.</p>
</section>
</section>
</section>


              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="install.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Developer Installation</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="workflows.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Workflows</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
              
          </main>
          

      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <!-- This will display the version of the docs -->
<p class="last-updated">
ActivitySim 1.2.0.dev409+g0d53eca3, documentation last updated Sep 27, 2022.<br/>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.5.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>